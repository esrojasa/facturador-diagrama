<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Diagrama Facturador</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: "default" });
    </script>
</head>
<body>
<pre class="mermaid">
sequenceDiagram
    title Ejecución Manual de Facturación, Liquidación y Causación (DRIXI/MOL → CUD → MRC)

    participant OP as Operador
    participant API as API Backend
    participant DB as BD (Transacciones / Parámetros / Logs)
    participant CUD as Sistema CUD (RTGS)
    participant MRC as Sistema MRC (Contable)
    participant STG as Storage / Archivos

    %% === 0️⃣ Parámetros y Reglas Previas ===
    Note over API,DB: Reglas nuevas ● tarifas por caso de uso ● tarifas DRIXI/MOL ● IVA con redondeo ● periodicidad ● parámetros mínimos ● control acceso logs

    %% === 1️⃣ Importación Manual de Transacciones (DRIXI/MOL) ===
    Note over OP: Importación manual de transacciones desde DRIXI y MOL
    OP->>API: POST /transactions/import {fecha, fuentes:[DRIXI,MOL]}
    API->>DB: Leer transacciones desde BD DRIXI/MOL
    API->>DB: Insert transacciones {banco, fecha, casoUso, monto, estado="PENDIENTE"}
    DB-->>API: OK (registros insertados)
    API-->>OP: 200 OK "Transacciones importadas y validadas"

    %% === 2️⃣ Configuración de Parámetros por Banco/Participante ===
    Note over OP: Carga de parámetros mínimos obligatorios
    OP->>API: POST /banks/params {tarifas por CU, tarifas DRIXI/MOL, IVA, reglaRedondeo, periodicidad}
    API->>DB: Upsert parámetros {vigencia, tipoEntidad, minParamsCheck}
    DB-->>API: OK

    %% === 3️⃣ Ejecución de Facturación (Cálculo Diario) ===
    Note over OP: Facturación consolidada por participante
    OP->>API: POST /process/manual/billing {fecha, participante}

    API->>DB: Validar parámetros mínimos (tarifas, IVA, redondeo, periodicidad)
    DB-->>API: OK

    API->>DB: Consolidar transacciones por participante/fecha
    DB-->>API: Totales por caso de uso

    API->>API: Aplicar tarifas + IVA + regla de redondeo
    API->>DB: Insert ProcessExecutionLog(tipo="FACTURACION", estado="PENDIENTE")

    alt Facturación Exitosa
        API->>STG: Generar reportes detallado, consolidado, GTA y conciliación (.txt)
        STG-->>API: URL archivos
        API->>DB: Update ProcessExecutionLog estado="ÉXITO"
    else Error en cálculo
        API->>STG: Generar archivo errores (.txt)
        API->>DB: Update ProcessExecutionLog estado="FALLIDO"
        Note over API: Disponible re-proceso vía POST /process/retry/{id}
    end

    API-->>OP: Resultado facturación {estado, archivos, idProceso}

    %% === 4️⃣ Ejecución Manual de Liquidación (RTGS/CUD) ===
    Note over OP: Liquidación de transacciones financieras reales (independiente de causación)
    OP->>API: POST /process/manual/liquidation {fecha, participante}

    API->>DB: Insert ProcessExecutionLog(tipo="LIQUIDACION", estado="PENDIENTE")
    API->>CUD: POST /rtgs/liquidate {participante, periodo}
    CUD-->>API: {estado:"OK"|"FALLIDO", motivo}

    alt Liquidación Exitosa
        API->>STG: Generar .txt liquidación (OK/pendientes/fallidos)
        STG-->>API: URL archivo
        API->>DB: Update ProcessExecutionLog estado="ÉXITO"
    else Fallo (incluye insuficiencia de fondos)
        API->>DB: Update ProcessExecutionLog estado="FALLIDO"
        Note over API: Reejecución permitida si motivo="INSUFICIENCIA_FONDOS"
    end

    API-->>OP: Resultado liquidación {estado, archivo, motivo}

    %% === 5️⃣ Ejecución Manual de Causación (MRC - DRIXI/MOL) ===
    Note over OP: Causación depende de FACTURACIÓN exitosa (no depende de liquidación)
    OP->>API: POST /process/manual/causation {fecha, participante}

    API->>DB: Buscar facturación exitosa por periodo
    DB-->>API: Totales consolidados por participante

    API->>MRC: POST /accounting/causation {asientosConsolidados}
    MRC-->>API: {estado:"OK"|"PARCIAL"|"ERROR", errores[]}

    alt Causación Exitosa
        API->>STG: Generar .txt asientos generados
        STG-->>API: URL archivo
        API->>DB: Update ProcessExecutionLog tipo="CAUSACION", estado="ÉXITO"
    else Error o Parcial
        API->>STG: Generar archivo .txt con errores detallados
        API->>DB: Update ProcessExecutionLog estado="FALLIDO"
    end

    API-->>OP: Resultado causación {estado, archivo, errores}

    %% === 6️⃣ Reintentos Manuales ===
    Note over OP: Reintento de facturación, liquidación o causación
    OP->>API: POST /process/retry/{idProceso}

    API->>DB: Obtener detalle de proceso previo {tipoProceso}
    DB-->>API: Datos cargados

    alt Tipo = LIQUIDACION
        API->>CUD: Reintentar liquidación {participante, periodo}
    else Tipo = CAUSACION
        API->>MRC: Reintentar causación {asientosConsolidados}
    else Tipo = FACTURACION
        API->>DB: Reprocesar facturación para el periodo
    end

    alt Reintento Exitoso
        API->>DB: Update estado="ÉXITO"
    else Falla Definitiva
        API->>DB: Update estado="FALLIDO_FINAL"
    end

    API-->>OP: Resultado reintento {estadoFinal}

</pre>
</body>
</html>
